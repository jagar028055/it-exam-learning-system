name: Auto Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
  check_suite:
    types: [completed]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]' || contains(github.event.pull_request.title, 'ğŸ¤– Claude Auto Fix')
    
    steps:
    - name: Check if PR is ready for merge
      id: check
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          
          // PRã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
          const checks = await github.rest.checks.listForRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: pr.head.sha
          });
          
          const allChecksPassed = checks.data.check_runs.every(check => 
            check.status === 'completed' && check.conclusion === 'success'
          );
          
          // CIã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
          const statuses = await github.rest.repos.listCommitStatusesForRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: pr.head.sha
          });
          
          const allStatusesPassed = statuses.data.length === 0 || 
            statuses.data.every(status => status.state === 'success');
          
          const canMerge = pr.mergeable && !pr.draft && allChecksPassed && allStatusesPassed;
          
          console.log(`PRçŠ¶æ…‹: mergeable=${pr.mergeable}, draft=${pr.draft}`);
          console.log(`ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹: ${allChecksPassed}, ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çŠ¶æ…‹: ${allStatusesPassed}`);
          console.log(`ãƒãƒ¼ã‚¸å¯èƒ½: ${canMerge}`);
          
          return canMerge;
    
    - name: Auto merge PR
      if: steps.check.outputs.result == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.pulls.merge({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
            merge_method: 'merge',
            commit_title: `Auto-merge: ${context.payload.pull_request.title}`,
            commit_message: `Automatically merged by GitHub Actions\n\n${context.payload.pull_request.body || ''}`
          });
          
          console.log('PRãŒè‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸï¼');
          
    - name: Post merge notification
      if: steps.check.outputs.result == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `ğŸ‰ **è‡ªå‹•ãƒãƒ¼ã‚¸å®Œäº†**\n\nâœ… å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒé€šéã—ãŸãŸã‚ã€PRã‚’è‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã—ã¾ã—ãŸã€‚\nğŸš€ Renderã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚\n\nğŸ“Š æ¬¡ã®æ‰‹é †:\n- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã®ç¢ºèª\n- [ ] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®ç¢ºèª\n- [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç›£è¦–`
          });

  post-merge-verification:
    needs: auto-merge
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Wait for deployment
      run: |
        echo "ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’å¾…æ©Ÿä¸­..."
        sleep 60
        
    - name: Verify deployment
      run: |
        echo "ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼ä¸­..."
        
        # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        if curl -f -s https://itexam-study-system.onrender.com/healthz; then
          echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
        else
          echo "âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—"
          exit 1
        fi
        
        # åŸºæœ¬çš„ãªæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        if curl -f -s https://itexam-study-system.onrender.com/ > /dev/null; then
          echo "âœ… ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ"
        else
          echo "âŒ ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—"
          exit 1
        fi
        
    - name: Create success notification
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          // æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰PRç•ªå·ã‚’å–å¾—
          const commit = context.payload.head_commit;
          const prMatch = commit.message.match(/#(\d+)/);
          
          if (prMatch) {
            const prNumber = prMatch[1];
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ğŸš€ **ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼å®Œäº†**\n\nâœ… è‡ªå‹•ãƒãƒ¼ã‚¸å¾Œã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼\n\nğŸ”— **ç¢ºèªãƒªãƒ³ã‚¯:**\n- [ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³](https://itexam-study-system.onrender.com)\n- [ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯](https://itexam-study-system.onrender.com/healthz)\n\nğŸ“Š **æ¤œè¨¼çµæœ:**\n- [x] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ\n- [x] ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ\n- [x] ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†\n\nâœ¨ ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ç¨¼åƒä¸­ã§ã™ï¼`
            });
          }
          
    - name: Rollback on failure
      if: failure()
      run: |
        echo "ğŸš¨ ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼å¤±æ•— - ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æ¤œè¨ã—ã¦ãã ã•ã„"
        echo "Render ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§å‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«æˆ»ã™ã‹ã€"
        echo "git revert ã§å¤‰æ›´ã‚’å–ã‚Šæ¶ˆã—ã¦ãã ã•ã„"