{% extends "base.html" %}

{% block title %}ã‚»ãƒƒã‚·ãƒ§ãƒ³çµæœ - æƒ…å ±æŠ€è¡“è€…è©¦é¨“å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- çµæœãƒãƒŠãƒ¼ -->
        <div class="text-center mb-5">
            {% set rate = (summary.correct_rate * 100)|round(1) %}
            {% if rate >= 90 %}
                <div class="alert alert-success" style="font-size: 1.2em;">
                    <i class="fas fa-trophy fa-2x"></i><br>
                    <strong>ğŸ‰ ç´ æ™´ã‚‰ã—ã„çµæœã§ã™ï¼</strong>
                </div>
            {% elif rate >= 70 %}
                <div class="alert alert-info" style="font-size: 1.2em;">
                    <i class="fas fa-thumbs-up fa-2x"></i><br>
                    <strong>ğŸ‘ è‰¯ã„çµæœã§ã™ï¼</strong>
                </div>
            {% elif rate >= 50 %}
                <div class="alert alert-warning" style="font-size: 1.2em;">
                    <i class="fas fa-book fa-2x"></i><br>
                    <strong>ğŸ“š ã¾ãšã¾ãšã®çµæœã§ã™</strong>
                </div>
            {% else %}
                <div class="alert alert-danger" style="font-size: 1.2em;">
                    <i class="fas fa-fist-raised fa-2x"></i><br>
                    <strong>ğŸ’ª æ¬¡å›ã¯é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼</strong>
                </div>
            {% endif %}
        </div>
        
        <!-- æˆç¸¾è¡¨ç¤º -->
        <div class="row justify-content-center mb-5">
            <div class="col-md-3">
                <div class="text-center">
                    <div class="position-relative d-inline-block">
                        <canvas id="scoreChart" width="200" height="200"></canvas>
                        <div class="position-absolute top-50 start-50 translate-middle">
                            <div class="display-4 fw-bold text-primary">
                                {% if rate >= 80 %}A
                                {% elif rate >= 70 %}B
                                {% elif rate >= 60 %}C
                                {% elif rate >= 50 %}D
                                {% else %}F
                                {% endif %}
                            </div>
                            <div class="text-muted">æˆç¸¾</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åŸºæœ¬çµ±è¨ˆ -->
        <div class="row mb-5">
            <div class="col-md-3 col-sm-6">
                <div class="card stat-card bg-primary text-white">
                    <div class="card-body">
                        <div class="stat-value">{{ summary.total_questions }}</div>
                        <div class="stat-label">ç·å•é¡Œæ•°</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card stat-card bg-success text-white">
                    <div class="card-body">
                        <div class="stat-value">{{ summary.correct_answers }}</div>
                        <div class="stat-label">æ­£è§£æ•°</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card stat-card bg-info text-white">
                    <div class="card-body">
                        <div class="stat-value">{{ rate }}</div>
                        <div class="stat-label">æ­£ç­”ç‡ (%)</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card stat-card bg-warning text-white">
                    <div class="card-body">
                        <div class="stat-value">{{ (summary.total_time / 60)|round(0) }}</div>
                        <div class="stat-label">æ‰€è¦æ™‚é–“ (åˆ†)</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è©³ç´°çµ±è¨ˆ -->
        <div class="row mb-5">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-stopwatch"></i> æ™‚é–“åˆ†æ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="text-info">
                                    <i class="fas fa-clock fa-2x mb-2"></i>
                                    <h6>å¹³å‡å›ç­”æ™‚é–“</h6>
                                    <p class="lead">{{ summary.average_response_time|round(0) }}ç§’</p>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-success">
                                    <i class="fas fa-tachometer-alt fa-2x mb-2"></i>
                                    <h6>æ™‚é–“åŠ¹ç‡</h6>
                                    <p class="lead">
                                        {% if summary.average_response_time <= 30 %}å„ªç§€
                                        {% elif summary.average_response_time <= 60 %}è‰¯å¥½
                                        {% elif summary.average_response_time <= 90 %}æ¨™æº–
                                        {% else %}è¦æ”¹å–„
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-primary">
                                    <i class="fas fa-calculator fa-2x mb-2"></i>
                                    <h6>å•é¡Œ/åˆ†</h6>
                                    <p class="lead">{{ (summary.total_questions / (summary.total_time / 60))|round(1) }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> çµæœå†…è¨³</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="resultChart" width="300" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é”æˆäº‹é … -->
        {% if summary.achievements %}
        <div class="row mb-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-trophy"></i> é”æˆäº‹é …</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for achievement in summary.achievements %}
                            <div class="col-md-6 mb-3">
                                <div class="alert alert-success d-flex align-items-center">
                                    <i class="fas fa-medal fa-2x me-3"></i>
                                    <div>
                                        <strong>{{ achievement }}</strong>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- å­¦ç¿’åˆ†é‡ -->
        {% if summary.categories_studied %}
        <div class="row mb-5">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-books"></i> å­¦ç¿’åˆ†é‡</h5>
                    </div>
                    <div class="card-body">
                        {% for category in summary.categories_studied %}
                        <span class="badge bg-primary me-2 mb-2" style="font-size: 0.9em;">{{ category }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- å¼±ç‚¹åˆ†é‡ -->
            {% if summary.weak_areas %}
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> æ”¹å–„ãŒå¿…è¦ãªåˆ†é‡</h5>
                    </div>
                    <div class="card-body">
                        {% for area in summary.weak_areas %}
                        <span class="badge bg-warning text-dark me-2 mb-2" style="font-size: 0.9em;">{{ area }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-rocket"></i> æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <a href="{{ url_for('study') }}" class="btn btn-primary w-100">
                                    <i class="fas fa-redo"></i><br>
                                    ã‚‚ã†ä¸€åº¦å­¦ç¿’
                                </a>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <a href="{{ url_for('study') }}?mode=weak_area" class="btn btn-warning w-100">
                                    <i class="fas fa-target"></i><br>
                                    å¼±ç‚¹å…‹æœ
                                </a>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <a href="{{ url_for('progress') }}" class="btn btn-info w-100">
                                    <i class="fas fa-chart-line"></i><br>
                                    é€²æ—ç¢ºèª
                                </a>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <button class="btn btn-success w-100" onclick="generateReport()">
                                    <i class="fas fa-file-alt"></i><br>
                                    ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
<div class="loading">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // æˆç¸¾å††ã‚°ãƒ©ãƒ•
    function createScoreChart() {
        const ctx = document.getElementById('scoreChart').getContext('2d');
        const rate = {{ (summary.correct_rate * 100)|round(1) }};
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [rate, 100 - rate],
                    backgroundColor: ['#28a745', '#e9ecef'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    // çµæœå†…è¨³ã‚°ãƒ©ãƒ•
    function createResultChart() {
        const ctx = document.getElementById('resultChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['æ­£è§£', 'ä¸æ­£è§£'],
                datasets: [{
                    data: [{{ summary.correct_answers }}, {{ summary.incorrect_answers }}],
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    function generateReport() {
        showLoading();
        
        fetch('/generate_report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'exam_type=FE&days=30'
        })
        .then(response => {
            hideLoading();
            if (response.ok) {
                alert('ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼');
                window.location.href = '/reports';
            } else {
                alert('ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        });
    }
    
    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
        createScoreChart();
        createResultChart();
        
        // ã‚«ãƒ¼ãƒ‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        const cards = document.querySelectorAll('.card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                card.style.transition = 'all 0.5s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
        
        // æˆç¸¾ã‚°ãƒ¬ãƒ¼ãƒ‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        const gradeElement = document.querySelector('.display-4');
        if (gradeElement) {
            gradeElement.style.transform = 'scale(0)';
            setTimeout(() => {
                gradeElement.style.transition = 'transform 0.5s ease';
                gradeElement.style.transform = 'scale(1)';
            }, 1000);
        }
    });
</script>
{% endblock %}
