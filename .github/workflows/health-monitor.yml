name: Health Monitor & Keep Alive

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ï¼ˆã‚µãƒ¼ãƒ“ã‚¹404ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ï¼‰
# on:
#   schedule:
#     # 30åˆ†é–“éš”ã§ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œï¼ˆè² è·è»½æ¸›ï¼‰
#     - cron: '*/30 * * * *'
#   workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã®ã¿æœ‰åŠ¹

permissions:
  issues: write
  contents: read

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
    - name: Check for existing failure issue
      id: check_issue
      uses: actions/github-script@v7
      with:
        script: |
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'health-check-failure'
          });
          
          if (issues.data.length > 0) {
            console.log(`An open health-check-failure issue exists (#${issues.data[0].number}). Skipping health check.`);
            return false;
          }
          
          console.log('No open health-check-failure issue found. Proceeding with health check.');
          return true;
        result-encoding: string
        
    - name: Keep service alive
      if: steps.check_issue.outputs.result == 'true'
      run: |
        echo "Pinging service to keep it alive..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://itexam-study-system.onrender.com/healthz)
        echo "Health check response: $response"
        
        if [ "$response" = "200" ]; then
          echo "âœ… Service is healthy"
        else
          echo "âŒ Service returned $response"
          exit 1
        fi
        
    - name: Create issue on failure
      if: failure() && steps.check_issue.outputs.result == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const title = `ğŸš¨ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•— - ${new Date().toISOString()}`;
          const body = `## ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸ
          
          **æ™‚åˆ»**: ${new Date().toISOString()}
          **URL**: https://itexam-study-system.onrender.com/healthz
          **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${context.workflow}
          **å®Ÿè¡ŒID**: ${context.runId}
          
          ### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã§ã™:
          - [ ] ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª
          - [ ] ãƒ­ã‚°ã‚’ç¢ºèª
          - [ ] å¿…è¦ã«å¿œã˜ã¦å†ãƒ‡ãƒ—ãƒ­ã‚¤
          
          ### é–¢é€£ãƒªãƒ³ã‚¯
          - [Render ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://dashboard.render.com)
          - [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ](${context.payload.repository.html_url}/actions/runs/${context.runId})
          `;
          
          // æ—¢å­˜ã®æœªè§£æ±ºãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯IssueãŒã‚ã‚‹ã‹ç¢ºèª
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'health-check-failure'
          });
          
          if (issues.data.length === 0) {
            // æ–°ã—ã„Issueã‚’ä½œæˆ
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['health-check-failure', 'urgent']
            });
          } else {
            // æ—¢å­˜ã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues.data[0].number,
              body: `## è¿½åŠ ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—\n\n**æ™‚åˆ»**: ${new Date().toISOString()}\n**å®Ÿè¡ŒID**: ${context.runId}`
            });
          }

  log-monitor:
    runs-on: ubuntu-latest
    steps:
    - name: Check for 500 errors
      run: |
        echo "Log monitoring placeholder - requires Render CLI setup"
        # Note: Render CLI ã§ãƒ­ã‚°ã‚’å–å¾—ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å‡¦ç†
        # ã“ã‚Œã¯å¾Œã§Render CLIã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¾Œã«å®Ÿè£…
        echo "TODO: Implement log monitoring with Render CLI"