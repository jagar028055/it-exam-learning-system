name: Log Analysis & Error Detection

on:
  schedule:
    # æ¯Žæ—¥åˆå‰2æ™‚ã«ãƒ­ã‚°è§£æžå®Ÿè¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      hours:
        description: 'è§£æžã™ã‚‹éŽåŽ»ã®æ™‚é–“æ•°'
        required: false
        default: '24'

jobs:
  log-analysis:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Render CLI
      run: |
        npm install -g @render-cli/cli
        
    - name: Fetch logs and analyze
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        # Render CLIã§ãƒ­ã‚°ã‚’å–å¾—
        echo "Fetching logs from Render..."
        
        # éŽåŽ»24æ™‚é–“ã®ãƒ­ã‚°ã‚’å–å¾—
        hours="${{ github.event.inputs.hours || '24' }}"
        
        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        render logs --service=$RENDER_SERVICE_ID --tail=1000 > latest.log 2>&1 || true
        
        echo "Analyzing logs for errors..."
        
        # 500ã‚¨ãƒ©ãƒ¼ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        error_500=$(grep -c " 500 " latest.log || echo "0")
        error_4xx=$(grep -c " 4[0-9][0-9] " latest.log || echo "0") 
        error_total=$(grep -c "ERROR" latest.log || echo "0")
        
        echo "Found $error_500 5xx errors, $error_4xx 4xx errors, $error_total ERROR logs"
        
        # ã‚¨ãƒ©ãƒ¼ã‚µãƒžãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        cat > error_summary.md << EOF
        # ãƒ­ã‚°è§£æžãƒ¬ãƒãƒ¼ãƒˆ - $(date)
        
        ## ã‚¨ãƒ©ãƒ¼çµ±è¨ˆ
        - **500ã‚¨ãƒ©ãƒ¼**: $error_500 ä»¶
        - **4xxã‚¨ãƒ©ãƒ¼**: $error_4xx ä»¶  
        - **ERRORãƒ­ã‚°**: $error_total ä»¶
        
        ## æœ€æ–°ã®500ã‚¨ãƒ©ãƒ¼ (ç›´è¿‘5ä»¶)
        \`\`\`
        $(grep " 500 " latest.log | tail -5)
        \`\`\`
        
        ## æœ€æ–°ã®ERRORãƒ­ã‚° (ç›´è¿‘5ä»¶)
        \`\`\`
        $(grep "ERROR" latest.log | tail -5)
        \`\`\`
        EOF
        
        # ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã®å‡¦ç†
        if [ "$error_500" -gt "0" ] || [ "$error_total" -gt "10" ]; then
          echo "CRITICAL_ERRORS_FOUND=true" >> $GITHUB_ENV
          echo "ERROR_500_COUNT=$error_500" >> $GITHUB_ENV
          echo "ERROR_TOTAL_COUNT=$error_total" >> $GITHUB_ENV
        else
          echo "CRITICAL_ERRORS_FOUND=false" >> $GITHUB_ENV
        fi
        
    - name: Upload log analysis
      uses: actions/upload-artifact@v4
      with:
        name: log-analysis-${{ github.run_id }}
        path: |
          latest.log
          error_summary.md
          
    - name: Create issue for critical errors
      if: env.CRITICAL_ERRORS_FOUND == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const errorSummary = fs.readFileSync('error_summary.md', 'utf8');
          
          const title = `ðŸš¨ 500ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ - ${process.env.ERROR_500_COUNT}ä»¶ (${new Date().toISOString().split('T')[0]})`;
          const body = `${errorSummary}
          
          ## å¯¾å¿œæ‰‹é †
          - [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—æ ¹æœ¬åŽŸå› ã‚’ç‰¹å®š
          - [ ] ä¿®æ­£ãƒ‘ãƒƒãƒã‚’ä½œæˆ
          - [ ] ãƒ†ã‚¹ãƒˆç’°å¢ƒã§å‹•ä½œç¢ºèª
          - [ ] æœ¬ç•ªç’°å¢ƒã¸ãƒ‡ãƒ—ãƒ­ã‚¤
          
          ## è‡ªå‹•åŒ–å¯èƒ½ãªå¯¾å¿œ
          ã“ã® Issue ã« \`@claude-fix\` ã¨ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã¨ã€Claude ãŒè‡ªå‹•ã§ãƒ‘ãƒƒãƒã‚’ç”Ÿæˆã—ã¾ã™ã€‚
          
          ### ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ
          - [ãƒ­ã‚°è§£æžçµæžœ](${context.payload.repository.html_url}/actions/runs/${context.runId})
          `;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['500-error', 'critical', 'auto-detected']
          });
          
    - name: Generate daily report
      if: env.CRITICAL_ERRORS_FOUND == 'false'
      run: |
        echo "No critical errors found. Generating daily report..."
        
        cat > daily_report.md << EOF
        # æ—¥æ¬¡ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒãƒ¼ãƒˆ - $(date)
        
        âœ… **ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹**: æ­£å¸¸
        ðŸ“Š **è§£æžæœŸé–“**: éŽåŽ»24æ™‚é–“
        
        ## çµ±è¨ˆæƒ…å ±
        - 500ã‚¨ãƒ©ãƒ¼: 0ä»¶
        - 4xxã‚¨ãƒ©ãƒ¼: ${ERROR_4XX_COUNT:-0}ä»¶
        - ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°: $(grep -c "GET\|POST\|PUT\|DELETE" latest.log || echo "N/A")
        
        ## æŽ¨å¥¨äº‹é …
        - ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«ç¨¼åƒã—ã¦ã„ã¾ã™
        - å®šæœŸçš„ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’ç¶™ç¶šã—ã¦ãã ã•ã„
        
        EOF