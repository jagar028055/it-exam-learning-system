name: Daily System Report

on:
  schedule:
    # æ¯æ—¥åˆå‰6æ™‚ (JSTåˆå¾Œ3æ™‚) ã«ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      report_type:
        description: 'ãƒ¬ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—'
        required: true
        default: 'daily'
        type: choice
        options:
        - daily
        - weekly
        - monthly

jobs:
  generate-report:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas matplotlib seaborn
        npm install -g @render-cli/cli
        
    - name: Generate system report
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        cat > generate_report.py << 'EOF'
        import json
        import requests
        import subprocess
        from datetime import datetime, timedelta
        import os
        import re
        
        def fetch_render_logs():
            """Renderã‹ã‚‰ãƒ­ã‚°ã‚’å–å¾—"""
            try:
                result = subprocess.run(
                    ['render', 'logs', '--service', os.environ['RENDER_SERVICE_ID'], '--tail', '1000'],
                    capture_output=True, text=True, timeout=60
                )
                return result.stdout
            except Exception as e:
                return f"ãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼: {e}"
        
        def analyze_logs(logs):
            """ãƒ­ã‚°ã‚’è§£æã—ã¦çµ±è¨ˆã‚’ä½œæˆ"""
            stats = {
                'total_requests': 0,
                'error_500': 0,
                'error_4xx': 0,
                'error_total': 0,
                'response_times': [],
                'popular_endpoints': {},
                'error_messages': []
            }
            
            lines = logs.split('\n')
            for line in lines:
                # HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ¤œå‡º
                if any(method in line for method in ['GET ', 'POST ', 'PUT ', 'DELETE ']):
                    stats['total_requests'] += 1
                    
                    # ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡º
                    endpoint_match = re.search(r'(GET|POST|PUT|DELETE)\s+([^\s]+)', line)
                    if endpoint_match:
                        endpoint = endpoint_match.group(2)
                        stats['popular_endpoints'][endpoint] = stats['popular_endpoints'].get(endpoint, 0) + 1
                
                # ã‚¨ãƒ©ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ¤œå‡º
                if ' 500 ' in line:
                    stats['error_500'] += 1
                elif re.search(r' 4[0-9][0-9] ', line):
                    stats['error_4xx'] += 1
                
                # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¤œå‡º
                if 'ERROR' in line or 'Exception' in line:
                    stats['error_total'] += 1
                    if len(stats['error_messages']) < 5:  # æœ€å¤§5ä»¶ã¾ã§ä¿å­˜
                        stats['error_messages'].append(line.strip())
            
            return stats
        
        def check_service_health():
            """ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"""
            try:
                response = requests.get('https://itexam-study-system.onrender.com/healthz', timeout=10)
                return {
                    'status': 'healthy' if response.status_code == 200 else 'unhealthy',
                    'response_time': response.elapsed.total_seconds(),
                    'status_code': response.status_code
                }
            except Exception as e:
                return {
                    'status': 'error',
                    'error': str(e),
                    'response_time': None,
                    'status_code': None
                }
        
        def generate_recommendations(stats, health):
            """æ”¹å–„ææ¡ˆã‚’ç”Ÿæˆ"""
            recommendations = []
            
            if stats['error_500'] > 0:
                recommendations.append(f"ğŸš¨ {stats['error_500']}ä»¶ã®500ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚åŸå› èª¿æŸ»ãŒå¿…è¦ã§ã™ã€‚")
            
            if stats['error_4xx'] > 10:
                recommendations.append(f"âš ï¸ {stats['error_4xx']}ä»¶ã®4xxã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚URLè¨­è¨ˆã®è¦‹ç›´ã—ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚")
            
            if health['response_time'] and health['response_time'] > 2.0:
                recommendations.append(f"ğŸŒ ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ãŒ{health['response_time']:.2f}ç§’ã§ã™ã€‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚")
            
            if health['status'] != 'healthy':
                recommendations.append("âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¦ã„ã¾ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
            
            if not recommendations:
                recommendations.append("âœ… ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«ç¨¼åƒã—ã¦ã„ã¾ã™ã€‚")
            
            return recommendations
        
        def main():
            print("ğŸ“Š æ—¥æ¬¡ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...")
            
            # ãƒ­ã‚°ã‚’å–å¾—ãƒ»è§£æ
            logs = fetch_render_logs()
            stats = analyze_logs(logs)
            
            # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
            health = check_service_health()
            
            # æ¨å¥¨äº‹é …ç”Ÿæˆ
            recommendations = generate_recommendations(stats, health)
            
            # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
            report_date = datetime.now().strftime('%Y-%m-%d')
            report = f"""# ğŸ“Š æ—¥æ¬¡ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒãƒ¼ãƒˆ - {report_date}
        
        ## ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹
        - **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: {health['status']}
        - **ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: {health['response_time']:.2f}ç§’ (ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯)
        - **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰**: {health['status_code']}
        
        ## ã‚¢ã‚¯ã‚»ã‚¹çµ±è¨ˆ (éå»24æ™‚é–“)
        - **ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°**: {stats['total_requests']:,}ä»¶
        - **500ã‚¨ãƒ©ãƒ¼**: {stats['error_500']}ä»¶
        - **4xxã‚¨ãƒ©ãƒ¼**: {stats['error_4xx']}ä»¶
        - **ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°**: {stats['error_total']}ä»¶
        
        ## äººæ°—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (Top 5)
        """
            
            # äººæ°—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ 
            sorted_endpoints = sorted(stats['popular_endpoints'].items(), key=lambda x: x[1], reverse=True)[:5]
            for i, (endpoint, count) in enumerate(sorted_endpoints, 1):
                report += f"{i}. `{endpoint}` - {count}å›\n"
            
            if stats['error_messages']:
                report += "\n## æœ€æ–°ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\n```\n"
                for error in stats['error_messages']:
                    report += f"{error}\n"
                report += "```\n"
            
            report += "\n## æ¨å¥¨äº‹é …\n"
            for rec in recommendations:
                report += f"- {rec}\n"
            
            report += f"""
        ## ãƒ¡ãƒˆãƒªã‚¯ã‚¹è©³ç´°
        - **ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ™‚åˆ»**: {datetime.now().isoformat()}
        - **ç›£è¦–æœŸé–“**: éå»24æ™‚é–“
        - **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: Render logs, ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯API
        
        ---
        ğŸ¤– Generated by GitHub Actions
        """
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
            with open('daily_report.md', 'w', encoding='utf-8') as f:
                f.write(report)
            
            print("âœ… ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†")
            
            # ã‚µãƒãƒªãƒ¼ã‚’GitHubç’°å¢ƒå¤‰æ•°ã«è¨­å®š
            os.environ['REPORT_STATUS'] = health['status']
            os.environ['ERROR_500_COUNT'] = str(stats['error_500'])
            os.environ['TOTAL_REQUESTS'] = str(stats['total_requests'])
            
            # GitHub Actionsã®å‡ºåŠ›ã«è¨­å®š
            with open(os.environ['GITHUB_ENV'], 'a') as env_file:
                env_file.write(f"REPORT_STATUS={health['status']}\n")
                env_file.write(f"ERROR_500_COUNT={stats['error_500']}\n")
                env_file.write(f"TOTAL_REQUESTS={stats['total_requests']}\n")
        
        if __name__ == '__main__':
            main()
        EOF
        
        python generate_report.py
        
    - name: Upload report as artifact
      uses: actions/upload-artifact@v4
      with:
        name: daily-report-${{ github.run_id }}
        path: daily_report.md
        
    - name: Post report to GitHub Issue
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('daily_report.md', 'utf8');
          
          const today = new Date().toISOString().split('T')[0];
          const title = `ğŸ“Š æ—¥æ¬¡ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒãƒ¼ãƒˆ - ${today}`;
          
          // æ—¢å­˜ã®æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆIssueãŒã‚ã‚‹ã‹ç¢ºèª
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'daily-report'
          });
          
          // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å«ã‚€IssueãŒã‚ã‚‹ã‹ç¢ºèª
          const todayIssue = issues.data.find(issue => 
            issue.title.includes(today)
          );
          
          if (todayIssue) {
            // æ—¢å­˜ã®Issueã‚’æ›´æ–°
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: todayIssue.number,
              body: report
            });
            console.log(`æ—¢å­˜ã®Issue #${todayIssue.number} ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
          } else {
            // æ–°ã—ã„Issueã‚’ä½œæˆ
            const newIssue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: report,
              labels: ['daily-report', 'system-monitoring']
            });
            console.log(`æ–°ã—ã„Issue #${newIssue.data.number} ã‚’ä½œæˆã—ã¾ã—ãŸ`);
            
            // 1é€±é–“å‰ã®ãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Œã°è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekAgoStr = weekAgo.toISOString().split('T')[0];
            
            const oldIssues = issues.data.filter(issue => 
              issue.title.includes(weekAgoStr)
            );
            
            for (const oldIssue of oldIssues) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: oldIssue.number,
                state: 'closed'
              });
              console.log(`å¤ã„ãƒ¬ãƒãƒ¼ãƒˆ #${oldIssue.number} ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã—ãŸ`);
            }
          }
          
    - name: Alert on critical issues
      if: env.ERROR_500_COUNT > 0 || env.REPORT_STATUS != 'healthy'
      uses: actions/github-script@v7
      with:
        script: |
          const title = `ğŸš¨ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆ - ${new Date().toISOString().split('T')[0]}`;
          const body = `## ğŸš¨ ã‚·ã‚¹ãƒ†ãƒ ã«å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ
          
          **ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${process.env.REPORT_STATUS}
          **500ã‚¨ãƒ©ãƒ¼æ•°**: ${process.env.ERROR_500_COUNT}ä»¶
          **ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°**: ${process.env.TOTAL_REQUESTS}ä»¶
          
          ## ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ã§ã™
          - [ ] ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®è©³ç´°ç¢ºèª
          - [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®èª¿æŸ»
          - [ ] å¿…è¦ã«å¿œã˜ã¦ç·Šæ€¥ä¿®æ­£
          
          ## é–¢é€£ãƒªãƒ³ã‚¯
          - [è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ](${context.payload.repository.html_url}/actions/runs/${context.runId})
          - [ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯](https://itexam-study-system.onrender.com/healthz)
          - [Renderãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://dashboard.render.com)
          `;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['critical', 'system-alert', 'urgent']
          });