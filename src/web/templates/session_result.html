{% extends "base.html" %}

{% block title %}セッション結果 - 情報技術者試験学習システム{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 結果バナー -->
        <div class="text-center mb-5">
            {% set rate = (summary.correct_rate * 100)|round(1) %}
            {% if rate >= 90 %}
                <div class="alert alert-success" style="font-size: 1.2em;">
                    <i class="fas fa-trophy fa-2x"></i><br>
                    <strong>🎉 素晴らしい結果です！</strong>
                </div>
            {% elif rate >= 70 %}
                <div class="alert alert-info" style="font-size: 1.2em;">
                    <i class="fas fa-thumbs-up fa-2x"></i><br>
                    <strong>👍 良い結果です！</strong>
                </div>
            {% elif rate >= 50 %}
                <div class="alert alert-warning" style="font-size: 1.2em;">
                    <i class="fas fa-book fa-2x"></i><br>
                    <strong>📚 まずまずの結果です</strong>
                </div>
            {% else %}
                <div class="alert alert-danger" style="font-size: 1.2em;">
                    <i class="fas fa-fist-raised fa-2x"></i><br>
                    <strong>💪 次回は頑張りましょう！</strong>
                </div>
            {% endif %}
        </div>
        
        <!-- 成績表示 -->
        <div class="row justify-content-center mb-5">
            <div class="col-md-3">
                <div class="text-center">
                    <div class="position-relative d-inline-block">
                        <canvas id="scoreChart" width="200" height="200"></canvas>
                        <div class="position-absolute top-50 start-50 translate-middle">
                            <div class="display-4 fw-bold text-primary">
                                {% if rate >= 80 %}A
                                {% elif rate >= 70 %}B
                                {% elif rate >= 60 %}C
                                {% elif rate >= 50 %}D
                                {% else %}F
                                {% endif %}
                            </div>
                            <div class="text-muted">成績</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 基本統計 -->
        <div class="row mb-5">
            <div class="col-md-3 col-sm-6">
                <div class="card stat-card bg-primary text-white">
                    <div class="card-body">
                        <div class="stat-value">{{ summary.total_questions }}</div>
                        <div class="stat-label">総問題数</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card stat-card bg-success text-white">
                    <div class="card-body">
                        <div class="stat-value">{{ summary.correct_answers }}</div>
                        <div class="stat-label">正解数</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card stat-card bg-info text-white">
                    <div class="card-body">
                        <div class="stat-value">{{ rate }}</div>
                        <div class="stat-label">正答率 (%)</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card stat-card bg-warning text-white">
                    <div class="card-body">
                        <div class="stat-value">{{ (summary.total_time / 60)|round(0) }}</div>
                        <div class="stat-label">所要時間 (分)</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 詳細統計 -->
        <div class="row mb-5">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-stopwatch"></i> 時間分析</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="text-info">
                                    <i class="fas fa-clock fa-2x mb-2"></i>
                                    <h6>平均回答時間</h6>
                                    <p class="lead">{{ summary.average_response_time|round(0) }}秒</p>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-success">
                                    <i class="fas fa-tachometer-alt fa-2x mb-2"></i>
                                    <h6>時間効率</h6>
                                    <p class="lead">
                                        {% if summary.average_response_time <= 30 %}優秀
                                        {% elif summary.average_response_time <= 60 %}良好
                                        {% elif summary.average_response_time <= 90 %}標準
                                        {% else %}要改善
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-primary">
                                    <i class="fas fa-calculator fa-2x mb-2"></i>
                                    <h6>問題/分</h6>
                                    <p class="lead">{{ (summary.total_questions / (summary.total_time / 60))|round(1) }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> 結果内訳</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="resultChart" width="300" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 達成事項 -->
        {% if summary.achievements %}
        <div class="row mb-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-trophy"></i> 達成事項</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for achievement in summary.achievements %}
                            <div class="col-md-6 mb-3">
                                <div class="alert alert-success d-flex align-items-center">
                                    <i class="fas fa-medal fa-2x me-3"></i>
                                    <div>
                                        <strong>{{ achievement }}</strong>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- 学習分野 -->
        {% if summary.categories_studied %}
        <div class="row mb-5">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-books"></i> 学習分野</h5>
                    </div>
                    <div class="card-body">
                        {% for category in summary.categories_studied %}
                        <span class="badge bg-primary me-2 mb-2" style="font-size: 0.9em;">{{ category }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- 弱点分野 -->
            {% if summary.weak_areas %}
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> 改善が必要な分野</h5>
                    </div>
                    <div class="card-body">
                        {% for area in summary.weak_areas %}
                        <span class="badge bg-warning text-dark me-2 mb-2" style="font-size: 0.9em;">{{ area }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- アクション -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-rocket"></i> 次のアクション</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <a href="{{ url_for('study') }}" class="btn btn-primary w-100">
                                    <i class="fas fa-redo"></i><br>
                                    もう一度学習
                                </a>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <a href="{{ url_for('study') }}?mode=weak_area" class="btn btn-warning w-100">
                                    <i class="fas fa-target"></i><br>
                                    弱点克服
                                </a>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <a href="{{ url_for('progress') }}" class="btn btn-info w-100">
                                    <i class="fas fa-chart-line"></i><br>
                                    進捗確認
                                </a>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <button class="btn btn-success w-100" onclick="generateReport()">
                                    <i class="fas fa-file-alt"></i><br>
                                    レポート生成
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ローディング -->
<div class="loading">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">レポートを生成中...</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 成績円グラフ
    function createScoreChart() {
        const ctx = document.getElementById('scoreChart').getContext('2d');
        const rate = {{ (summary.correct_rate * 100)|round(1) }};
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [rate, 100 - rate],
                    backgroundColor: ['#28a745', '#e9ecef'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    // 結果内訳グラフ
    function createResultChart() {
        const ctx = document.getElementById('resultChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['正解', '不正解'],
                datasets: [{
                    data: [{{ summary.correct_answers }}, {{ summary.incorrect_answers }}],
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // レポート生成
    function generateReport() {
        showLoading();
        
        fetch('/generate_report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'exam_type=FE&days=30'
        })
        .then(response => {
            hideLoading();
            if (response.ok) {
                alert('レポートが生成されました！');
                window.location.href = '/reports';
            } else {
                alert('レポート生成に失敗しました。');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('エラーが発生しました。');
        });
    }
    
    // ページロード時の初期化
    document.addEventListener('DOMContentLoaded', function() {
        createScoreChart();
        createResultChart();
        
        // カードのアニメーション
        const cards = document.querySelectorAll('.card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                card.style.transition = 'all 0.5s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
        
        // 成績グレードのアニメーション
        const gradeElement = document.querySelector('.display-4');
        if (gradeElement) {
            gradeElement.style.transform = 'scale(0)';
            setTimeout(() => {
                gradeElement.style.transition = 'transform 0.5s ease';
                gradeElement.style.transform = 'scale(1)';
            }, 1000);
        }
    });
</script>
{% endblock %}
